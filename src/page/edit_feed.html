<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Postingan - SampahKita</title>
    <link rel="icon" type="image/png" href="../../assets/img/logo.png" />
    <link rel="stylesheet" href="../../assets/css/sampah_kita.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", "Segoe UI", sans-serif;
        color: #1f2937;
        background-color: #f0fdf4;
      }

      .font-lora {
        font-family: "Lora", serif;
      }

      .sticky-header {
        position: sticky;
        top: 0;
        z-index: 50;
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
      }

      .notification.success {
        background-color: #10b981;
        color: white;
      }

      .notification.error {
        background-color: #ef4444;
        color: white;
      }

      .notification.info {
        background-color: #3b82f6;
        color: white;
      }

      .notification i {
        font-size: 1.25rem;
      }

      .notification-close {
        margin-left: auto;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
      }

      .notification-close:hover {
        opacity: 1;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .notification.slide-out {
        animation: slideOut 0.3s ease-out forwards;
      }

      dialog {
        border: none;
        padding: 0;
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 400px;
        width: 90%;
      }

      dialog#delete-modal {
        background-color: #ffffff;
        padding: 1.5rem; /* p-6 */
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        border: none;
        max-width: 500px;
        width: 90%;

        /* === TAMBAHAN UNTUK CENTER === */
        margin: auto; /* Kunci untuk centering */
        height: fit-content; /* Pastikan tinggi dialog pas dengan konten */
        /* ============================== */
      }
      /* (Berasal dari 'md:p-8') */
      @media (min-width: 768px) {
        dialog#delete-modal {
          padding: 2rem;
        }
      }

      /* --- Header Modal --- */
      /* (Berasal dari 'mb-4 flex items-center gap-3') */
      .modal-header {
        margin-bottom: 1rem; /* mb-4 */
        display: flex; /* flex */
        align-items: center; /* items-center */
        gap: 0.75rem; /* gap-3 */
      }

      /* --- Ikon Wrapper (Lingkaran Merah) --- */
      /* (Berasal dari 'w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600') */
      .modal-icon-wrapper {
        width: 2.5rem; /* w-10 */
        height: 2.5rem; /* h-10 */
        background-color: #fef2f2; /* bg-red-100 */
        border-radius: 9999px; /* rounded-full */
        display: flex; /* flex */
        align-items: center; /* items-center */
        justify-content: center; /* justify-center */
        color: #dc2626; /* text-red-600 */
      }

      /* --- Ikon di dalam Wrapper --- */
      /* (Berasal dari 'text-xl') */
      .modal-icon-wrapper i {
        font-size: 1.25rem; /* text-xl */
        line-height: 1.75rem;
      }

      /* --- Judul Modal --- */
      /* (Berasal dari 'text-xl font-bold text-gray-800 font-lora') */
      #modal-title {
        font-size: 1.25rem; /* text-xl */
        line-height: 1.75rem;
        font-weight: 700; /* font-bold */
        color: #1f2937; /* text-gray-800 */
        font-family: "Lora", serif; /* font-lora */
      }

      /* --- Konten Modal --- */
      /* (Berasal dari 'mb-6') */
      #modal-content {
        margin-bottom: 1.5rem; /* mb-6 */
      }

      /* --- Paragraf Konten Modal --- */
      /* (Berasal dari 'text-gray-600') */
      #modal-content p {
        color: #4b5563; /* text-gray-600 */
        line-height: 1.5; /* Default yang baik */
      }

      /* --- Footer Modal --- */
      /* (Berasal dari 'flex justify-end gap-3') */
      .modal-footer {
        display: flex; /* flex */
        justify-content: flex-end; /* justify-end */
        gap: 0.75rem; /* gap-3 */
      }

      /* --- Tombol Modal (Gaya Dasar) --- */
      /* (Berasal dari 'w-full sm:w-auto px-4 py-2 rounded-lg transition font-semibold text-sm') */
      .modal-button {
        width: 100%; /* w-full */
        padding-left: 1rem; /* px-4 */
        padding-right: 1rem; /* px-4 */
        padding-top: 0.5rem; /* py-2 */
        padding-bottom: 0.5rem; /* py-2 */
        border-radius: 0.5rem; /* rounded-lg */
        transition-property: background-color, border-color, color, fill, stroke; /* transition */
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
        font-weight: 600; /* font-semibold */
        font-size: 0.875rem; /* text-sm */
        line-height: 1.25rem;
        border: none;
        cursor: pointer;
      }
      /* (Berasal dari 'sm:w-auto') */
      @media (min-width: 640px) {
        .modal-button {
          width: auto;
        }
      }

      /* --- Tombol Batal (Spesifik) --- */
      /* (Berasal dari 'bg-gray-200 text-gray-700 hover:bg-gray-300') */
      .modal-button-cancel {
        background-color: #e5e7eb; /* bg-gray-200 */
        color: #374151; /* text-gray-700 */
      }
      .modal-button-cancel:hover {
        background-color: #d1d5db; /* hover:bg-gray-300 */
      }

      /* --- Tombol Konfirmasi (Spesifik) --- */
      /* (Berasal dari 'bg-red-600 text-white hover:bg-red-700') */
      .modal-button-confirm {
        background-color: #dc2626; /* bg-red-600 */
        color: #ffffff; /* text-white */
      }
      .modal-button-confirm:hover {
        background-color: #b91c1c; /* hover:bg-red-700 */
      }

      /* --- Ikon di dalam Tombol Konfirmasi --- */
      /* (Berasal dari 'mr-1') */
      .modal-button-confirm i {
        margin-right: 0.25rem; /* mr-1 */
      }
    </style>
  </head>

  <body>
    <header
      id="navbar-sk"
      class="sticky-header top-0 z-50 bg-white/80 backdrop-blur-sm shadow-sm"
    ></header>

    <main class="max-w-2xl mx-auto px-4 py-12 md:py-16">
      <div class="text-center mb-10">
        <h1 class="font-lora text-3xl md:text-4xl font-bold text-gray-800">
          Edit Postingan Anda
        </h1>
        <p class="mt-2 text-gray-600">
          Perbarui informasi atau gambar postingan feed Anda.
        </p>
      </div>

      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-100"
      >
        <form id="edit-form" method="POST">
          <div class="mb-6">
            <label class="block font-semibold text-gray-700 mb-2"
              >Gambar Postingan</label
            >
            <div id="post-image"></div>
            <input
              type="file"
              name="image"
              id="image-upload"
              style="display: none"
            />
            <label
              for="image-upload"
              class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-semibold text-sm"
            >
              <i class="fas fa-camera"></i> Ganti Gambar
            </label>
          </div>

          <div class="mb-6">
            <label
              for="post-text"
              class="block font-semibold text-gray-700 mb-2"
              >Teks Postingan</label
            >
            <textarea
              id="post-text"
              name="content"
              rows="6"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none resize-none"
              placeholder="Tuliskan sesuatu..."
            >
#SampahKita</textarea
            >
          </div>

          <div
            class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-8"
          >
            <button
              type="button"
              id="delete-button"
              style="cursor: pointer"
              class="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition font-semibold order-2 sm:order-1"
            >
              <i class="fas fa-trash-alt"></i> Hapus Postingan
            </button>
            <button
              type="submit"
              style="cursor: pointer"
              class="w-full sm:w-auto flex items-center justify-center gap-2 px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold text-lg order-1 sm:order-2"
            >
              <i class="fas fa-save"></i> Simpan Perubahan
            </button>
          </div>
        </form>
      </div>
    </main>

    <footer id="footer" class="bg-gray-900 text-white pt-16 pb-8">
      <div class="max-w-7xl mx-auto px-4">
        <div class="grid md:grid-cols-4 gap-8 mb-12">
          <div>
            <div class="flex items-center gap-2 mb-4">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center">
                <img src="../../assets/img/logo.png" alt="" />
              </div>
              <span class="text-2xl font-bold">SampahKita</span>
            </div>
            <p class="text-gray-400 text-sm">
              Platform digital untuk manajemen sampah yang efisien dan
              berkelanjutan.
            </p>
          </div>
          <div>
            <h4 class="text-lg font-bold mb-4">Halaman</h4>
            <ul class="space-y-2 text-gray-400">
              <li>
                <a href="bank_sampah" class="hover:text-green-400 transition"
                  >Bank Sampah</a
                >
              </li>
              <li>
                <a href="feed" class="hover:text-green-400 transition">Feed</a>
              </li>
              <li>
                <a href="scan" class="hover:text-green-400 transition"
                  >Scan Sampah</a
                >
              </li>
              <li>
                <a href="learderboard" class="hover:text-green-400 transition"
                  >Leaderboard</a
                >
              </li>
              <li>
                <a href="about_us" class="hover:text-green-400 transition"
                  >Tentang Kami</a
                >
              </li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-bold mb-4">Hubungi Kami</h4>
            <ul class="space-y-2 text-gray-400">
              <li>
                <a
                  href="mailto:info@sk.com"
                  class="hover:text-green-400 transition"
                  >info@sk.com</a
                >
              </li>
              <li>
                <a
                  href="tel:+62123456789"
                  class="hover:text-green-400 transition"
                  >+62 123 4567 890</a
                >
              </li>
              <li class="text-sm">Jl. Diponegoro No. 69, Salatiga</li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-bold mb-4">Ikuti Kami</h4>
            <div class="flex gap-4">
              <a
                href="https://www.instagram.com/ftiuksw/"
                class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-green-500 transition"
                ><i class="fab fa-instagram"></i
              ></a>
              <a
                href="#"
                class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-green-500 transition"
                ><i class="fab fa-facebook"></i
              ></a>
              <a
                href="#"
                class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-green-500 transition"
                ><i class="fab fa-twitter"></i
              ></a>
              <a
                href="#"
                class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-green-500 transition"
                ><i class="fab fa-youtube"></i
              ></a>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-800 pt-8 text-center text-gray-400">
          <p>&copy; 2025 SampahKita Community. All Rights Reserved.</p>
        </div>
      </div>
    </footer>

    <dialog id="delete-modal">
      <header class="modal-header">
        <div class="modal-icon-wrapper">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2 id="modal-title">Konfirmasi Penghapusan</h2>
      </header>

      <div id="modal-content">
        <p>
          Apakah Anda <strong>yakin</strong> ingin menghapus feed ini? Tindakan
          ini <strong>tidak dapat dibatalkan</strong>.
        </p>
        <input type="hidden" id="post-to-delete-id" value="" />
      </div>

      <footer class="modal-footer">
        <button
          id="cancel-delete-button"
          class="modal-button modal-button-cancel"
        >
          Batal
        </button>
        <button
          id="confirm-delete-button"
          class="modal-button modal-button-confirm"
        >
          <i class="fas fa-trash-alt"></i> Hapus Permanen
        </button>
      </footer>
    </dialog>
    <script src="../../assets/js/sampahkita.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const feed_id = params.get("feed_id");
      const postTextEl = document.getElementById("post-text");
      const postImageWrap = document.getElementById("post-image");
      const imageUploadInput = document.getElementById("image-upload");
      const editForm = document.getElementById("edit-form");
      function load_post(i) {
        fetch(`../../api/edit_feed.php?feed_id=${i}`)
          .then((response) => response.json())
          .then((data_feed) => {
            console.log(data_feed);
            if (data_feed.status === "error") {
              window.location.href = "403";
              return;
            }
            postTextEl.value = data_feed.data.content ?? "";
            if (data_feed.data.image && data_feed.data.image.trim() !== "") {
              postImageWrap.innerHTML = `
            <img id="image-preview"
              src="../../${data_feed.data.image}"
              alt="Pratinjau Gambar Postingan"
              class="w-full h-auto max-h-80 object-cover rounded-lg shadow-md mb-4 border" />`;
            } else {
              postImageWrap.innerHTML = "";
            }
          })
          .catch((err) => {
            console.error("Gagal load post:", err);
            alert("Gagal memuat postingan.");
          });
      }

      if (feed_id) load_post(feed_id);
      window._currentObjectURL = window._currentObjectURL || null;

      imageUploadInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          alert("Silakan pilih file gambar.");
          imageUploadInput.value = ""; // reset input
          return;
        }

        if (window._currentObjectURL) {
          URL.revokeObjectURL(window._currentObjectURL);
          window._currentObjectURL = null;
        }
        let img = document.getElementById("image-preview");
        if (!img) {
          img = document.createElement("img");
          img.id = "image-preview";
          img.alt = "Pratinjau Gambar Postingan";
          img.className =
            "w-full h-auto max-h-80 object-cover rounded-lg shadow-md mb-4 border";
          postImageWrap.innerHTML = "";
          postImageWrap.appendChild(img);
        }
        const objectURL = URL.createObjectURL(file);
        window._currentObjectURL = objectURL;
        img.src = objectURL;
      });
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(editForm);
        if (!formData.has("feed_id")) {
          formData.append("feed_id", feed_id);
        }

        try {
          const res = await fetch(
            `../../api/edit_feed.php?feed_id=${feed_id}`,
            {
              method: "POST",
              body: formData,
            }
          );

          const data = await res.json();
          alert(data.message);

          if (data.status === "sukses") {
            if (window._currentObjectURL) {
              URL.revokeObjectURL(window._currentObjectURL);
              window._currentObjectURL = null;
            }
            load_post(feed_id);
          }
        } catch (err) {
          console.error(err);
          alert("Terjadi kesalahan saat menyimpan perubahan.");
        }
      });

      function showNotification(message, type = "info") {
        const existing = document.querySelector(".notification");
        if (existing) {
          existing.remove();
        }

        const notification = document.createElement("div");
        notification.className = `notification ${type}`;

        let icon = "fa-info-circle";
        if (type === "success") icon = "fa-check-circle";
        if (type === "error") icon = "fa-exclamation-circle";

        notification.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
        <i class="fas fa-times notification-close"></i>
      `;

        document.body.appendChild(notification);

        notification
          .querySelector(".notification-close")
          .addEventListener("click", () => {
            notification.classList.add("slide-out");
            setTimeout(() => notification.remove(), 300);
          });

        setTimeout(() => {
          if (notification.parentElement) {
            notification.classList.add("slide-out");
            setTimeout(() => notification.remove(), 300);
          }
        }, 5000);
      }

      async function delete_feed(i) {
        // Dapatkan elemen dialog dan tombol
        const dialog = document.getElementById("delete-modal");
        const confirmBtn = document.getElementById("confirm-delete-button");
        const originalHtml = confirmBtn.innerHTML; // Simpan HTML asli

        // Tampilkan loader dan nonaktifkan tombol
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Menghapus...`;

        try {
          const res = await fetch("../../api/delete_feed.php", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ feed_id: i }),
          });
          const data = await res.json();

          if (data.status === "sukses") {
            showNotification("Feed berhasil diubah", "success");
            setTimeout(() => {
              window.location.href = "feed"; // Redirect on success
            }, 500);
          } else {
            // Jika gagal (status != "sukses")
            showNotification(data.message, "error");
            // Kembalikan tombol ke normal dan tutup dialog
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalHtml;
            dialog.close();
          }
        } catch (err) {
          // Jika terjadi error fetch/jaringan
          console.error(err);
          showNotification("Terjadi kesalahan saat menghapus feed", "error");

          // Kembalikan tombol ke normal dan tutup dialog
          confirmBtn.disabled = false;
          confirmBtn.innerHTML = originalHtml;
          dialog.close();
        }
      }
    </script>

    <script>
      // --- Dapatkan semua elemen untuk dialog ---
      const deleteDialog = document.getElementById("delete-modal");
      const deleteButton = document.getElementById("delete-button"); // Tombol di form
      const confirmBtn = document.getElementById("confirm-delete-button"); // Tombol di dialog
      const cancelBtn = document.getElementById("cancel-delete-button"); // Tombol di dialog

      if (deleteDialog) {
        // --- Script untuk menutup dialog saat backdrop diklik ---
        deleteDialog.addEventListener("click", (event) => {
          // Dapatkan area persegi dialog di layar
          const rect = deleteDialog.getBoundingClientRect();

          // Cek apakah koordinat klik (event.clientY, event.clientX)
          // berada DI LUAR area persegi tersebut
          const isInDialog =
            rect.top <= event.clientY &&
            event.clientY <= rect.top + rect.height &&
            rect.left <= event.clientX &&
            event.clientX <= rect.left + rect.width;

          // Jika klik TIDAK di dalam dialog (!isInDialog)
          if (!isInDialog) {
            deleteDialog.close();
          }
        });
      }

      // --- Script untuk MEMBUKA dialog saat tombol Hapus di form diklik ---
      if (deleteButton && confirmBtn && cancelBtn && deleteDialog) {
        // 1. Tampilkan dialog saat tombol 'Hapus Postingan' di form diklik
        deleteButton.addEventListener("click", () => {
          // 2. Atur tombol 'Hapus Permanen' di dialog untuk memanggil delete_feed
          //    Gunakan .onclick agar bisa di-overwrite setiap kali dibuka
          confirmBtn.onclick = () => delete_feed(feed_id); // 'feed_id' dari script pertama

          // 3. Atur tombol 'Batal' di dialog untuk menutup
          cancelBtn.onclick = () => deleteDialog.close();

          // 4. Tampilkan dialog
          deleteDialog.showModal();
        });
      }
    </script>
  </body>
</html>
